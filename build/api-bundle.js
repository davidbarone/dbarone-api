!function(e){var t={};function s(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(n,r,function(t){return e[t]}.bind(null,r));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=8)}([function(e,t){e.exports=require("express")},function(e,t){e.exports=require("knex")},function(e,t,s){s(6).config(),e.exports={client:"postgresql",connection:{host:process.env.DB_HOST,post:process.env.DB_PORT,database:process.env.DB_DATABASE,user:process.env.DB_USER,password:process.env.DB_PASSWORD},pool:{min:2,max:10},migrations:{tableName:"knex_migrations"}}},function(e,t){e.exports=require("objection")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,s){const n=s(4),r=process.env.APP_SECRET_KEY;e.exports=function(e,t,s){let o=e.headers["x-auth-token"]||e.headers.authorization;if(o&&o.startsWith("Bearer ")&&(o=o.slice(7,o.length).trim()),!o)return t.status(401).send("Access denied. No token provided.");try{const t=n.verify(o,r);e.user=t,s()}catch(e){t.status(400).send("Invalid token.")}}},function(e,t){e.exports=require("dotenv")},function(e,t){e.exports=require("bcryptjs")},function(e,t,s){e.exports=s(9)},function(e,t,s){const n=s(0),r=s(10),o=s(11);s(6);const a=s(1),i=s(2),{Model:d}=s(3),c=a(i);d.knex(c);const u=s(12),p=s(16),l=s(19),y=n(),g=process.env.PORT||3e3;y.use(r.json()),y.use([r.urlencoded({extended:!0}),o({origin:["http://localhost:3000","https://dbarone.com","https://www.dbarone.com"],exposedHeaders:["x-access-token"]})]),y.use("/users",u),y.use("/posts",p),y.use("/resources",l),y.get("/",(e,t)=>{t.json({info:"Node.js, Express, and Postgres API"})}),y.listen(g,()=>{console.log(`App running on port ${g}.`)})},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("cors")},function(e,t,s){s(4);const n=s(5),r=(s(7),s(13),s(0)),o=s(14),a=r.Router();a.get("/current",o.getUser),a.post("/",n,o.createUser),a.post("/login",o.login),e.exports=a},function(e,t){e.exports=require("joi")},function(e,t,s){const n=s(15),r=s(7);e.exports=class{static async createUser(e,t){try{const s=e.body;s.password=await r.hash(s.password,10);const o=await n.query().insert(s),a=o.generateAuthToken();console.log(a),t.header("x-auth-token",a).status(200).send({id:o.id,name:o.name,email:o.email,role:o.role})}catch(e){throw t.status(500).send(e),new Error(e)}}static async getUser(e,t){try{const s=parseInt(e.params.id),r=await n.query().findById(s).select("id, email, name, role");t.status(200).json(r)}catch(e){throw t.status(500).send(e),new Error("whoops")}}static async login(e,t){try{const s=e.body;if(console.log(e),!s.email)return t.status(422).json({errors:{email:"is required"}});if(!s.password)return t.status(422).json({errors:{password:"is required"}});const o=s.email,a=await n.query().where({email:o}).first();if(!a)throw new Error("Authentication Failed");if(console.log(a),!await r.compare(s.password,a.password))throw new Error("Authentication Failed");const i=a.generateAuthToken();t.header("x-access-token",i).status(200).send({id:a.id,name:a.name,email:a.email,role:a.role})}catch(e){throw t.status(500).send(e),new Error(e)}}}},function(e,t,s){const n=s(4),r=s(1),o=s(2),{Model:a}=s(3),i=r(o);a.knex(i);e.exports=class extends a{static get tableName(){return"user"}generateAuthToken(){try{return n.sign({id:this.id,email:this.email,name:this.name,role:this.role},process.env.APP_SECRET_KEY,{expiresIn:28800})}catch(e){throw new Error(e)}}static get jsonSchema(){return{type:"object",required:["email","name","password","role"],properties:{id:{type:"integer"},email:{type:"string",minLength:1,maxLength:250},name:{type:"string",minLength:1,maxLength:250},password:{type:"string",minLength:1,maxLength:250},role:{type:"string",minLength:1,maxLength:50}}}}}},function(e,t,s){const n=s(0).Router(),r=s(17),o=s(5);n.get("/",r.getPosts),n.get("/:id",r.getPost),n.get("/:id/relations",r.getRelated),n.post("/",o,r.createPost),n.delete("/:id",o,r.deletePost),n.put("/:id",o,r.updatePost),e.exports=n},function(e,t,s){const n=s(18);e.exports=class{static async getPosts(e,t){try{const e=await n.query().orderBy("published_dt","desc");t.status(200).json(e)}catch(e){throw t.status(500).send(e),new Error("whoops")}}static async createPost(e,t){try{e.body.updated_dt=(new Date).toISOString(),e.body.updated_by=e.user.name;const s=await n.query().insert(e.body);t.status(201).json(s)}catch(e){throw t.status(500).send(e),new Error(e)}}static async getPost(e,t){try{const s=parseInt(e.params.id),r=await n.query().findById(s);t.status(200).json(r)}catch(e){throw t.status(500).send(e),new Error("whoops")}}static async getRelated(e,t){try{const s=parseInt(e.params.id),r=(await n.query().findById(s)).parent_id,o=e.get("host"),a=e.protocol,i=await n.query().findById(r).select(["id","title"]),d=await n.query().where("parent_id",r).whereNotNull("parent_id").orderBy("title").select(["id","title"]);d.map(e=>e.url=`${a}://${o}/posts/${e.id}`);const c=await n.query().where("parent_id",s).orderBy("title").select(["id","title"]);c.map(e=>e.url=`${a}://${o}/posts/${e.id}`),t.status(200).json({hasRelations:!!(i||Array.isArray(d)&&d.length||Array.isArray(c)&&c.length),parent:i||null,siblings:d,children:c})}catch(e){throw t.status(500).send(e),new Error(e)}}static async updatePost(e,t){try{console.log(e.body.parent_id);const s=parseInt(e.params.id);await n.query().findById(s).patch(e.body);t.status(200).send("Updated OK")}catch(e){throw t.status(500).send(e),new Error(e)}}static async deletePost(e,t){try{const s=parseInt(e.params.id);await n.query().deleteById(s);t.status(200).send("Deleted OK")}catch(e){throw t.status(500).send(e),new Error("whoops")}}}},function(e,t,s){const n=s(1),r=s(2),{Model:o}=s(3),a=n(r);o.knex(a);e.exports=class extends o{static get tableName(){return"post"}static get jsonSchema(){return{type:"object",required:["teaser","post_type","updated_dt","updated_by","published_dt","deleted"],properties:{id:{type:"integer"},title:{type:"string",minLength:1,maxLength:250},teaser:{type:"string",minLength:1,maxLength:1e3},content:{type:"string"},code:{type:"string"},style:{type:"string"},head:{type:"string"},post_type:{type:"string",minLength:1,maxLength:20},parent_id:{type:["integer","null"]},updated_dt:{type:"string",format:"date-time"},updated_by:{type:"string",minLength:1,maxLength:250},published_dt:{type:"string",format:"date-time"},deleted:{type:"boolean"}}}}}},function(e,t,s){const n=s(0).Router(),r=s(20),o=s(5);n.get("/",r.getResources),n.get("/:id",r.getResource),n.get("/name/:file_name",r.getResourceByName),n.post("/upload",o,r.uploadResource),n.delete("/:id",o,r.deleteResource),e.exports=n},function(e,t,s){const n=s(21);s(22);var r=s(23),o=s(24);e.exports=class{static async deleteResource(e,t){try{const s=parseInt(e.params.id);await n.query().deleteById(s);t.status(200).send("Deleted OK")}catch(e){throw t.status(500).send(e),new Error(e)}}static async uploadResource(e,t){(new r.IncomingForm).parse(e,(function(s,r,a){console.log(a);const i=a.resourceFile.path,d=o.readFileSync(i),c=a.resourceFile,u={file_name:c.name,media_type:c.type,data:"\\x"+d.toString("hex"),updated_dt:(new Date).toISOString(),updated_by:e.user.name,deleted:!1};o.unlinkSync(i);n.query().insert(u).then(async e=>{const s=(await n.query().select("id","file_name","media_type","deleted","updated_dt","updated_by")).filter(t=>t.id===e.id)[0];t.status(201).json(s),t.end()})}))}static async getResources(e,t){try{const e=await n.query().select("id","file_name","media_type","deleted","updated_dt","updated_by");t.status(200).json(e)}catch(e){throw t.status(500).send(e),new Error("whoops")}}static async getResource(e,t){try{const s=parseInt(e.params.id),r=await n.query().findById(s);t.writeHead(200,{"Content-Type":`${r.media_type}`,"Content-Disposition":`filename="${r.file_name}"`}),t.end(r.data)}catch(e){throw t.status(500).send(e),new Error("whoops")}}static async getResourceByName(e,t){try{const s=e.params.file_name;console.log(s);const r=await n.query().where({file_name:s}).first();t.writeHead(200,{"Content-Type":`${r.media_type}`,"Content-Disposition":`filename="${r.file_name}"`}),t.end(r.data)}catch(e){throw t.status(500).send(e),new Error("whoops")}}}},function(e,t,s){const n=s(1),r=s(2),{Model:o}=s(3),a=n(r);o.knex(a);e.exports=class extends o{static get tableName(){return"resource"}static get jsonSchema(){return{type:"object",required:["file_name","media_type","updated_dt","updated_by","updated_dt","deleted"],properties:{id:{type:"integer"},file_name:{type:"string",minLength:1,maxLength:250},data:{type:"string"},media_type:{type:"string",minLength:1,maxLength:250},updated_dt:{type:"string",format:"date-time"},updated_by:{type:"string",minLength:1,maxLength:250},deleted:{type:"boolean"}}}}}},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("formidable")},function(e,t){e.exports=require("fs")}]);